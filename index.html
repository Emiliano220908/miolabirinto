<!DOCTYPE html>
<html>
<head>
    <title>Labirinto Pro Abruzzo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #222; color: white; padding-top: 50px; touch-action: none; }
        #game-area {
            width: 300px;
            height: 300px;
            border: 5px solid white;
            margin: 20px auto;
            position: relative;
            background-color: #000;
        }
        #player {
            width: 30px;
            height: 30px;
            background-color: #00ff00; 
            position: absolute;
            top: 135px; left: 135px;
            border-radius: 50%;
            /* NESSUNA TRANSIZIONE CSS: Il movimento lo fa Javascript fluido */
        }
        #status { color: yellow; font-weight: bold; margin-bottom: 20px;}
    </style>
</head>
<body>

    <h1>ðŸš€ Labirinto Real-Time</h1>
    <div id="status">Connessione...</div>
    <div id="game-area"><div id="player"></div></div>

    <script>
        // --- CONFIGURAZIONE ---
        const topic = "labirinto_abruzzo_test/comandi"; 
        const broker = "test.mosquitto.org";
        const port = 8081; 
        // ----------------------

        const client = new Paho.MQTT.Client(broker, port, "web_" + Date.now());

        let posX = 135;
        let posY = 135;
        let direzioneAttuale = "STOP"; // Memorizza dove stiamo andando
        const velocita = 4; // Pixel per fotogramma (Aumenta per andare piÃ¹ veloce)

        // --- IL MOTORE DI GIOCO (Loop Infinito) ---
        // Questo gira 60 volte al secondo fluidissimo
        function gameLoop() {
            if (direzioneAttuale === "SU" && posY > 0) posY -= velocita;
            if (direzioneAttuale === "GIU" && posY < 270) posY += velocita;
            if (direzioneAttuale === "SINISTRA" && posX > 0) posX -= velocita;
            if (direzioneAttuale === "DESTRA" && posX < 270) posX += velocita;

            // Applica la posizione
            const player = document.getElementById('player');
            player.style.top = posY + 'px';
            player.style.left = posX + 'px';

            requestAnimationFrame(gameLoop); // Ripeti al prossimo frame
        }

        client.onMessageArrived = function (message) {
            const comando = message.payloadString;
            console.log("Comando: " + comando);
            
            // Aggiorniamo solo la direzione, il loop sopra fa il movimento
            direzioneAttuale = comando;
            
            // Feedback visivo nel testo
            document.getElementById('status').innerText = "Stato: " + comando;
        };

        const options = {
            useSSL: true,
            onSuccess: function () {
                document.getElementById('status').innerText = "âœ… Pronto! Muovi il Joystick.";
                client.subscribe(topic);
                gameLoop(); // AVVIA IL MOTORE GRAFICO
            },
            onFailure: function (e) {
                document.getElementById('status').innerText = "âŒ Errore: " + e.errorMessage;
            }
        };

        client.connect(options);
    </script>
</body>
</html>
