<!DOCTYPE html>
<html>
<head>
    <title>Labirinto Grafico + Joystick</title>
    <style>
        body { 
            font-family: sans-serif; 
            text-align: center; 
            background-color: #222; 
            color: white; 
            padding-top: 20px;
        }
        
        /* L'area di gioco ora √® una griglia */
        #game-area {
            width: 400px;
            height: 400px;
            border: 5px solid white;
            margin: 20px auto;
            position: relative;
            background-color: #000;
            display: grid;
            grid-template-columns: repeat(10, 40px); /* 10 colonne da 40px */
            grid-template-rows: repeat(10, 40px);    /* 10 righe da 40px */
        }

        /* Stile dei muri */
        .wall {
            background-color: #666; /* Grigio */
            border: 1px solid #444;
            box-sizing: border-box;
        }

        /* Stile del percorso (vuoto) */
        .path {
            background-color: transparent;
        }

        /* Il Giocatore */
        #player {
            width: 30px;  /* Leggermente pi√π piccolo della casella per estetica */
            height: 30px;
            background-color: #00ff00; /* Verde acceso */
            position: absolute;
            transition: top 0.1s, left 0.1s;
            border-radius: 5px;
            z-index: 10; /* Sta sopra i muri */
            
            /* Centriamo il player nella casella */
            margin-top: 5px; 
            margin-left: 5px;
        }

        button { 
            padding: 15px 30px; 
            font-size: 20px; 
            cursor: pointer; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 5px; 
        }
        #status { margin-top: 15px; color: yellow; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üïπÔ∏è Labirinto Grafico</h1>
    
    <button id="connectBtn">üîå CONNETTI ARDUINO (USB)</button>
    <p>Oppure premi un tasto sul Joystick Bluetooth collegato al PC</p>
    
    <div id="status">Stato: In attesa...</div>
    
    <div id="game-area">
        <div id="player"></div>
    </div>

    <script>
        let port, reader;
        
        // --- CONFIGURAZIONE LABIRINTO (1 = Muro, 0 = Strada) ---
        // Griglia 10x10. Ogni casella √® 40px.
        const map = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 1, 0, 0, 0, 0, 1],
            [1, 0, 1, 1, 1, 0, 1, 1, 0, 1],
            [1, 0, 1, 0, 0, 0, 0, 1, 0, 1],
            [1, 0, 1, 0, 1, 1, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 0, 1, 1, 1, 1],
            [1, 0, 0, 0, 1, 0, 1, 0, 0, 1],
            [1, 0, 1, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
        ];

        // Posizione Iniziale (Griglia X, Y) -> Corrisponde a map[1][1]
        let gridX = 1;
        let gridY = 1;
        const cellSize = 40; // Grandezza casella in pixel

        // --- DISEGNA IL LABIRINTO ---
        const gameArea = document.getElementById('game-area');
        const player = document.getElementById('player');

        function drawMaze() {
            for (let r = 0; r < 10; r++) {
                for (let c = 0; c < 10; c++) {
                    const cell = document.createElement('div');
                    if (map[r][c] === 1) {
                        cell.classList.add('wall');
                    } else {
                        cell.classList.add('path');
                    }
                    gameArea.appendChild(cell); // Aggiunge la casella al gioco
                }
            }
            // Rimettiamo il player sopra a tutto
            gameArea.appendChild(player);
            updatePlayerPosition();
        }
        drawMaze(); // Avvia disegno

        // --- CONNESSIONE ARDUINO (USB) ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            if ("serial" in navigator) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 9600 });
                    const textDecoder = new TextDecoderStream();
                    port.readable.pipeTo(textDecoder.writable);
                    reader = textDecoder.readable.getReader();
                    document.getElementById('status').innerText = "‚úÖ Arduino Connesso!";
                    readLoop();
                } catch (err) {
                    document.getElementById('status').innerText = "‚ùå Errore: " + err;
                }
            }
        });

        // Legge Arduino USB
        async function readLoop() {
            let buffer = ""; 
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    buffer += value;
                    if (buffer.includes('\n')) {
                        const comandi = buffer.split('\n');
                        buffer = comandi.pop(); 
                        for (let cmd of comandi) muoviGiocatore(cmd.trim());
                    }
                }
            }
        }

        // --- GESTIONE JOYSTICK BLUETOOTH (PC DIRETTO) ---
        // Se colleghi il joy al PC via Bluetooth, questo loop lo legge
        let lastMoveTime = 0;
        function gameLoop() {
            const gamepads = navigator.getGamepads();
            const gp = gamepads[0]; // Primo controller connesso

            if (gp && Date.now() - lastMoveTime > 150) { // Ritardo per non correre troppo
                // Analogico Sinistro
                if (gp.axes[1] < -0.5) muoviGiocatore("SU");
                else if (gp.axes[1] > 0.5) muoviGiocatore("GIU");
                else if (gp.axes[0] < -0.5) muoviGiocatore("SINISTRA");
                else if (gp.axes[0] > 0.5) muoviGiocatore("DESTRA");
            }
            requestAnimationFrame(gameLoop);
        }
        gameLoop(); // Avvia il controllo Joystick continuo

        window.addEventListener("gamepadconnected", () => {
            document.getElementById('status').innerText = "üéÆ Joystick Bluetooth Trovato!";
        });

        // --- LOGICA DI MOVIMENTO E COLLISIONI ---
        function muoviGiocatore(direzione) {
            let nextX = gridX;
            let nextY = gridY;

            // Calcola dove vorresti andare
            if (direzione === "SU") nextY--;
            if (direzione === "GIU") nextY++;
            if (direzione === "SINISTRA") nextX--;
            if (direzione === "DESTRA") nextX++;

            // CONTROLLO MURI: Ci muoviamo solo se nella mappa c'√® 0 (strada)
            // e non usciamo dai bordi (0-9)
            if (nextX >= 0 && nextX < 10 && nextY >= 0 && nextY < 10) {
                if (map[nextY][nextX] === 0) {
                    // Strada libera! Aggiorna posizione
                    gridX = nextX;
                    gridY = nextY;
                    updatePlayerPosition();
                    lastMoveTime = Date.now(); // Reset timer per joystick
                } else {
                    console.log("SBAM! Hai preso un muro.");
                }
            }
        }

        function updatePlayerPosition() {
            // Moltiplichiamo la griglia per 40px per trovare i pixel reali
            player.style.top = (gridY * cellSize) + 'px';
            player.style.left = (gridX * cellSize) + 'px';
        }
    </script>
</body>
</html>
