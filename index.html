<script>
        let port;
        let reader;
        
        let posX = 180;
        let posY = 180;
        const step = 40; 

        document.getElementById('connectBtn').addEventListener('click', async () => {
            if ("serial" in navigator) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 9600 });
                    
                    const textDecoder = new TextDecoderStream();
                    const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                    reader = textDecoder.readable.getReader();
                    
                    document.getElementById('status').innerText = "✅ Connesso! Guarda la Console (F12)";
                    readLoop();
                } catch (err) {
                    console.error("Errore:", err);
                    alert("Errore di connessione: " + err);
                }
            } else {
                alert("Il tuo browser non supporta la Web Serial. Usa Chrome o Edge aggiornati.");
            }
        });

        async function readLoop() {
            let buffer = ""; // Memoria temporanea per i pezzi di testo

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    // Metti tutto quello che arriva nel buffer
                    buffer += value;
                    
                    // Stampiamo nella console quello che arriva grezzo (per debug)
                    console.log("Dati grezzi ricevuti:", value);

                    // Se c'è un "a capo", significa che il comando è finito
                    if (buffer.includes('\n')) {
                        const comandi = buffer.split('\n');
                        
                        // L'ultimo pezzo potrebbe essere incompleto, lo rimettiamo nel buffer
                        buffer = comandi.pop(); 

                        for (let comando of comandi) {
                            comando = comando.trim(); // Pulisci spazi vuoti
                            console.log("Comando pulito:", comando); // DEBUG
                            muoviGiocatore(comando);
                        }
                    }
                }
            }
        }

        function muoviGiocatore(direzione) {
            // Controlliamo ESATTAMENTE cosa arriva (case sensitive)
            if (direzione === "SU" && posY > 0) posY -= step;
            if (direzione === "GIU" && posY < 360) posY += step;
            if (direzione === "SINISTRA" && posX > 0) posX -= step;
            if (direzione === "DESTRA" && posX < 360) posX += step;

            const player = document.getElementById('player');
            player.style.top = posY + 'px';
            player.style.left = posX + 'px';
        }
    </script>
