<!DOCTYPE html>
<html>
<head>
    <title>Labirinto IoT Abruzzo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #222; color: white; padding-top: 50px; }
        #game-area {
            width: 300px;
            height: 300px;
            border: 5px solid white;
            margin: 20px auto;
            position: relative;
            background-color: #000;
        }
        #player {
            width: 30px;
            height: 30px;
            background-color: #00ff00; 
            position: absolute;
            top: 135px; left: 135px;
            transition: all 0.1s;
            border-radius: 50%;
        }
        #status { color: yellow; font-weight: bold; margin-bottom: 20px;}
        .debug { font-size: 12px; color: #888; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>üåç Labirinto Globale (Sicuro)</h1>
    <div id="status">Connessione al server sicuro in corso...</div>
    
    <div id="game-area">
        <div id="player"></div>
    </div>
    
    <div class="debug">Premi F12 se non si connette e guarda la Console.</div>

    <script>
        // --- CONFIGURAZIONE ---
        // ‚ö†Ô∏è INCOLLA QUI LO STESSO TOPIC CHE HAI MESSO SU ARDUINO!
        const topic = "labirinto_abruzzo_test/comandi"; 
        // ----------------------

        // Usiamo la porta 8884 che √® quella PROTETTA (WSS)
        const broker = "broker.hivemq.com";
        const port = 8884; 
        
        const clientID = "web_client_" + Math.random().toString(16).substr(2, 8);
        const client = new Paho.MQTT.Client(broker, port, clientID);

        let posX = 135;
        let posY = 135;
        const step = 30;

        client.onConnectionLost = function (responseObject) {
            document.getElementById('status').innerText = "‚ùå Connessione Persa: " + responseObject.errorMessage;
            console.log("Status: " + responseObject.errorMessage);
        };

        client.onMessageArrived = function (message) {
            const comando = message.payloadString;
            console.log("Comando ricevuto: " + comando);
            
            // Feedback visivo che √® arrivato qualcosa
            document.getElementById('status').innerText = "‚úÖ Ricevuto: " + comando;

            if (comando === "SU" && posY > 0) posY -= step;
            if (comando === "GIU" && posY < 270) posY += step;
            if (comando === "SINISTRA" && posX > 0) posX -= step;
            if (comando === "DESTRA" && posX < 270) posX += step;

            const player = document.getElementById('player');
            player.style.top = posY + 'px';
            player.style.left = posX + 'px';
        };

        const options = {
            useSSL: true, // <--- QUESTO √à IL TRUCCO PER GITHUB PAGES!
            onSuccess: function () {
                document.getElementById('status').innerText = "‚úÖ Connesso al Server Sicuro!";
                client.subscribe(topic);
                console.log("Iscritto al canale: " + topic);
            },
            onFailure: function (e) {
                document.getElementById('status').innerText = "‚ùå Errore Connessione: " + e.errorMessage;
                console.log(e);
            }
        };

        // Prova a connettere
        console.log("Tentativo di connessione a " + broker + ":" + port);
        client.connect(options);
    </script>
</body>
</html>
