<!DOCTYPE html>
<html>
<head>
    <title>Labirinto IoT Abruzzo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #222; color: white; padding-top: 50px; }
        #game-area {
            width: 300px;
            height: 300px;
            border: 5px solid white;
            margin: 20px auto;
            position: relative;
            background-color: #000;
        }
        #player {
            width: 30px;
            height: 30px;
            background-color: #00ff00; /* Verde brillante */
            position: absolute;
            top: 135px; left: 135px;
            transition: all 0.1s;
            border-radius: 50%;
        }
        #status { color: yellow; font-weight: bold; margin-bottom: 20px;}
    </style>
</head>
<body>

    <h1>üåç Labirinto Globale</h1>
    <div id="status">Connessione al server in corso...</div>
    
    <div id="game-area">
        <div id="player"></div>
    </div>
    
    <p>Apri questo sito anche dal telefono!</p>

    <script>
        // --- CONFIGURAZIONE ---
        // DEVE ESSERE UGUALE A QUELLO MESSO SU ARDUINO!
        const topic = "labirinto_abruzzo_test/comandi"; 
        // ----------------------

        const broker = "broker.hivemq.com";
        const port = 8000; // Porta WebSockets
        
        // Creiamo un ID casuale per il sito
        const clientID = "web_client_" + Math.random().toString(16).substr(2, 8);
        const client = new Paho.MQTT.Client(broker, port, clientID);

        // Posizione Giocatore
        let posX = 135;
        let posY = 135;
        const step = 30;

        // Quando arrivano messaggi
        client.onMessageArrived = function (message) {
            const comando = message.payloadString;
            console.log("Arrivato: " + comando);
            
            if (comando === "SU" && posY > 0) posY -= step;
            if (comando === "GIU" && posY < 270) posY += step;
            if (comando === "SINISTRA" && posX > 0) posX -= step;
            if (comando === "DESTRA" && posX < 270) posX += step;

            const player = document.getElementById('player');
            player.style.top = posY + 'px';
            player.style.left = posX + 'px';
        };

        // Opzioni di connessione
        const options = {
            onSuccess: function () {
                document.getElementById('status').innerText = "‚úÖ Connesso al Mondo!";
                // Ci iscriviamo al canale per ascoltare Arduino
                client.subscribe(topic);
            },
            onFailure: function (e) {
                document.getElementById('status').innerText = "‚ùå Errore: " + e.errorMessage;
            }
        };

        // Connettiti!
        client.connect(options);
    </script>
</body>
</html>
