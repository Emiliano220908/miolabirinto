<!DOCTYPE html>
<html>
<head>
    <title>Labirinto Arduino</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #333; color: white; }
        #game-area {
            width: 400px;
            height: 400px;
            border: 5px solid white;
            margin: 20px auto;
            position: relative;
            background-color: #000;
        }
        #player {
            width: 40px;
            height: 40px;
            background-color: red;
            position: absolute;
            top: 180px; /* Centro verticale */
            left: 180px; /* Centro orizzontale */
            transition: all 0.1s; /* Movimento fluido */
        }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; background: #4CAF50; border: none; color: white; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>üïπÔ∏è Labirinto Arduino Web</h1>
    <p>Collega l'Arduino, clicca il bottone e muovi il Joystick!</p>
    
    <button id="connectBtn">üîå CONNETTI ARDUINO</button>
    
    <div id="game-area">
        <div id="player"></div>
    </div>

    <script>
        let port;
        let reader;
        
        // Posizione iniziale del giocatore
        let posX = 180;
        let posY = 180;
        const step = 40; // Di quanto si muove ogni volta

        document.getElementById('connectBtn').addEventListener('click', async () => {
            // Chiede il permesso di usare la porta USB
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            
            // Impostiamo la lettura dei dati
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            
            readLoop();
        });

        async function readLoop() {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    // Arduino manda pezzi di testo, noi cerchiamo le parole chiave
                    const comandi = value.split('\n');
                    for (let comando of comandi) {
                        muoviGiocatore(comando.trim());
                    }
                }
            }
        }

        function muoviGiocatore(direzione) {
            if (direzione === "SU" && posY > 0) posY -= step;
            if (direzione === "GIU" && posY < 360) posY += step;
            if (direzione === "SINISTRA" && posX > 0) posX -= step;
            if (direzione === "DESTRA" && posX < 360) posX += step;

            // Applica il movimento al quadrato rosso
            const player = document.getElementById('player');
            player.style.top = posY + 'px';
            player.style.left = posX + 'px';
        }
    </script>
</body>
</html>